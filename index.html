<!DOCTYPE html>
<html lang="uk">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Діана — голосовий помічник</title>
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs"></script>
  <script src="https://unpkg.com/@readyplayerme/visage@latest/dist/visage.min.js"></script>
</head>
<body style="margin:0; overflow:hidden; background:black">
  <div id="avatar" style="width:100vw; height:60vh;"></div>
  <div id="log" style="color:white; padding:10px; font-family:sans-serif"></div>
  <script>
    const avatarUrl = "https://models.readyplayer.me/64f6e18806aa6f0e96f2e2bb.glb";
    const avatarViewer = new window.ReadyPlayerMe.Visage(document.getElementById("avatar"));
    avatarViewer.loadModel(avatarUrl);

    const speak = (text) => {
      const utterance = new SpeechSynthesisUtterance(text);
      utterance.lang = "uk-UA";
      utterance.pitch = 1.1;
      utterance.rate = 1;
      speechSynthesis.speak(utterance);
    };

    const log = (txt) => {
      document.getElementById("log").innerText = txt;
    };

    const openaiApiKey = "sk-live_ffTNEWvztMlnTQeYGHxshMXOe7m9sGICikxd";

    const getGPTResponse = async (prompt) => {
      const response = await fetch("https://api.openai.com/v1/chat/completions", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "Authorization": "Bearer " + openaiApiKey,
        },
        body: JSON.stringify({
          model: "gpt-3.5-turbo",
          messages: [{ role: "user", content: prompt }],
        }),
      });
      const data = await response.json();
      const reply = data.choices?.[0]?.message?.content;
      return reply || "Не можу зараз відповісти.";
    };

    const processCommand = async (text) => {
      log("Ви сказали: " + text);
      let reply;

      if (text.includes("привіт")) reply = "Привіт! Я твій голосовий помічник Діана.";
      else if (text.includes("погода")) reply = "Зараз не підключено API погоди, але я можу це додати.";
      else if (text.includes("що ти вмієш")) reply = "Я вмію відповідати на твої запитання і допомагати тобі.";
      else reply = await getGPTResponse(text);

      speak(reply);
      log("Діана: " + reply);
    };

    const recognition = new (window.SpeechRecognition || window.webkitSpeechRecognition)();
    recognition.lang = "uk-UA";
    recognition.continuous = true;
    recognition.interimResults = false;

    recognition.onresult = (event) => {
      const transcript = event.results[event.results.length - 1][0].transcript.trim();
      processCommand(transcript);
    };

    recognition.onerror = (e) => {
      log("Помилка розпізнавання: " + e.error);
    };

    recognition.onend = () => {
      recognition.start();
    };

    recognition.start();
    speak("Діана готова допомагати.");
  </script>
</body>
</html>
