<!DOCTYPE html>
<html lang="uk">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Діана - помічник</title>
  <style>
    body { font-family: sans-serif; padding: 15px; }
    #log { white-space: pre-wrap; border: 1px solid #ccc; height: 150px; overflow-y: scroll; padding: 10px; }
  </style>
</head>
<body>
  <h2>Діана - голосовий помічник</h2>
  <div id="log">Очікую команду...</div>
<script>
(async () => {
  const logDiv = document.getElementById('log');
  let dianaVoice = null;

  function selectVoice() {
    const voices = speechSynthesis.getVoices();
    dianaVoice = voices.find(v => v.lang.startsWith('uk') && v.name.toLowerCase().includes('child'))
             || voices.find(v => v.lang.startsWith('uk') && v.name.toLowerCase().includes('female'))
             || voices.find(v => v.lang.startsWith('uk')) || voices[0];
  }
  speechSynthesis.onvoiceschanged = selectVoice;
  selectVoice();

  const speak = (text) => new Promise(resolve => {
    const utter = new SpeechSynthesisUtterance(text);
    utter.lang = 'uk-UA';
    utter.voice = dianaVoice;
    utter.onend = resolve;
    speechSynthesis.speak(utter);
  });

  const recognition = new (window.SpeechRecognition || window.webkitSpeechRecognition)();
  recognition.lang = 'uk-UA';
  recognition.continuous = true;
  recognition.interimResults = false;

  const openWeatherKey = '9e41a977a87bb7f26c0afca1fba5b84f';
  const openRouterKey = 'sk-or-xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx'; // заміни на робочий ключ
  const sanityToken = 'sk6sza4rqhTXPAIeJsdcxqH6Mgr9Nut0Ia9qkLTdWs4RILSYOcFhYQDWTHJahTagTPTfLFyQPxleAMcCgzaZWlEGztOJjEoHnEQ1oQImjGINrisW311meoOjsl66AFRq91yxL2QUFDRhH77402CkMq3vRQpQvgwNDpLbRRykPU3CoSdZHDt4';

  async function getWeather(city) {
    try {
      const res = await fetch(`https://api.openweathermap.org/data/2.5/weather?q=${encodeURIComponent(city)}&appid=${openWeatherKey}&units=metric&lang=ua`);
      const data = await res.json();
      return `У місті ${city} зараз ${data.weather[0].description}, температура ${Math.round(data.main.temp)}°C.`;
    } catch {
      return `Не вдалося отримати погоду для ${city}.`;
    }
  }

  async function askGPT(prompt) {
    try {
      const res = await fetch("https://openrouter.ai/api/v1/chat/completions", {
        method: "POST",
        headers: {
          "Authorization": `Bearer ${openRouterKey}`,
          "Content-Type": "application/json"
        },
        body: JSON.stringify({
          model: "openai/gpt-3.5-turbo",
          messages: [{ role: "user", content: prompt }]
        })
      });
      const json = await res.json();
      return json.choices?.[0]?.message?.content || "Не знаю, що відповісти.";
    } catch {
      return "Виникла помилка при зверненні до ШІ.";
    }
  }

  let isActive = false;

  recognition.onresult = async (e) => {
    const transcript = e.results[e.results.length - 1][0].transcript.trim().toLowerCase();
    logDiv.textContent = `Почув: ${transcript}`;

    if (!isActive && transcript.includes("діана")) {
      isActive = true;
      await speak("Так, я тут.");
      return;
    }

    if (!isActive) return;

    let reply = '';
    if (transcript.includes("погода в")) {
      const city = transcript.split("погода в")[1]?.trim();
      if (city) reply = await getWeather(city);
      else reply = "Не зрозуміла назву міста.";
    } else {
      reply = await askGPT(transcript);
    }

    logDiv.textContent += `\nВідповідь: ${reply}`;
    await speak(reply);
  };

  recognition.onerror = (e) => {
    logDiv.textContent = `Помилка: ${e.error}`;
  };

  recognition.onend = () => {
    recognition.start(); // автоматично поновлює прослуховування
  };

  recognition.start(); // автоматичний запуск

})();
</script>
</body>
</html>
