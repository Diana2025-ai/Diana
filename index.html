<!DOCTYPE html>
<html lang="uk">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>–î—ñ–∞–Ω–∞ - –≥–æ–ª–æ—Å–æ–≤–∏–π –ø–æ–º—ñ—á–Ω–∏–∫</title>
  <style>
    body { font-family: sans-serif; padding: 20px; }
    #log { border: 1px solid #ccc; padding: 10px; height: 200px; overflow-y: auto; }
    button { margin-top: 10px; padding: 10px 20px; font-size: 16px; }
  </style>
</head>
<body>

<h2>üéôÔ∏è –î—ñ–∞–Ω–∞ ‚Äî –≥–æ–ª–æ—Å–æ–≤–∏–π –ø–æ–º—ñ—á–Ω–∏–∫</h2>
<div id="log">–û—á—ñ–∫—É—é –∫–æ–º–∞–Ω–¥–∏ "–î—ñ–∞–Ω–∞"...</div>
<button id="start-btn">–ó–∞–ø—É—Å—Ç–∏—Ç–∏ –î—ñ–∞–Ω—É</button>

<script>
(async () => {
  const logDiv = document.getElementById('log');
  const startBtn = document.getElementById('start-btn');

  const openaiKey = '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';
  const weatherKey = '9e41a977a87bb7f26c0afca1fba5b84f';

  const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
  const synth = window.speechSynthesis;

  if (!SpeechRecognition || !synth) {
    logDiv.textContent = '–ë—Ä–∞—É–∑–µ—Ä –Ω–µ –ø—ñ–¥—Ç—Ä–∏–º—É—î SpeechRecognition –∞–±–æ SpeechSynthesis';
    return;
  }

  const recognition = new SpeechRecognition();
  recognition.lang = 'uk-UA';
  recognition.continuous = true;
  recognition.interimResults = false;

  let isActive = false;
  let isSpeaking = false;

  function speak(text) {
    return new Promise((resolve) => {
      const utter = new SpeechSynthesisUtterance(text);
      utter.lang = 'uk-UA';
      utter.onend = resolve;
      synth.speak(utter);
    });
  }

  async function getGPTReply(question) {
    const res = await fetch('https://api.openai.com/v1/chat/completions', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'Authorization': `Bearer ${openaiKey}`
      },
      body: JSON.stringify({
        model: 'gpt-3.5-turbo',
        messages: [{ role: 'user', content: question }],
        temperature: 0.7
      })
    });
    const data = await res.json();
    return data.choices?.[0]?.message?.content || "–í–∏–±–∞—á, —è –Ω–µ –∑–Ω–∞—é, —â–æ –≤—ñ–¥–ø–æ–≤—ñ—Å—Ç–∏.";
  }

  async function getWeather(city) {
    try {
      const res = await fetch(`https://api.openweathermap.org/data/2.5/weather?q=${city}&appid=${weatherKey}&units=metric&lang=ua`);
      const data = await res.json();
      if (!data.weather) return null;
      return `–£ –º—ñ—Å—Ç—ñ ${city} –∑–∞—Ä–∞–∑ ${data.weather[0].description}, —Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞ ${Math.round(data.main.temp)}¬∞C.`;
    } catch {
      return null;
    }
  }

  recognition.onresult = async (event) => {
    if (isSpeaking) return;
    const transcript = event.results[event.results.length - 1][0].transcript.trim().toLowerCase();
    logDiv.textContent = `üó£Ô∏è –ü–æ—á—É–≤: ${transcript}`;

    if (!isActive) {
      if (transcript.includes('–¥—ñ–∞–Ω–∞')) {
        isActive = true;
        await speak("–¢–∞–∫, —è —Å–ª—É—Ö–∞—é");
        logDiv.textContent = "üî¥ –ê–∫—Ç–∏–≤–Ω–∞, —á–µ–∫–∞—é –∑–∞–ø–∏—Ç...";
      }
      return;
    }

    isActive = false;
    isSpeaking = true;

    let answer = '';

    if (transcript.includes('–ø–æ–≥–æ–¥–∞ –≤')) {
      const city = transcript.split('–ø–æ–≥–æ–¥–∞ –≤')[1]?.trim();
      if (city) {
        answer = await getWeather(city) || '–ù–µ –≤–¥–∞–ª–æ—Å—è –æ—Ç—Ä–∏–º–∞—Ç–∏ –ø–æ–≥–æ–¥—É.';
      } else {
        answer = '–ë—É–¥—å –ª–∞—Å–∫–∞, –≤–∫–∞–∂–∏ –º—ñ—Å—Ç–æ.';
      }
    } else {
      answer = await getGPTReply(transcript);
    }

    logDiv.textContent = `ü§ñ –í—ñ–¥–ø–æ–≤—ñ–¥—å: ${answer}`;
    await speak(answer);
    isSpeaking = false;
  };

  recognition.onerror = e => {
    logDiv.textContent = `‚ùå –ü–æ–º–∏–ª–∫–∞: ${e.error}`;
  };

  recognition.onend = () => {
    if (!isSpeaking) recognition.start(); // –∞–≤—Ç–æ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫
  };

  startBtn.onclick = () => {
    recognition.start();
    startBtn.disabled = true;
    logDiv.textContent = 'üéß –°–ª—É—Ö–∞—é... —Å–∫–∞–∂–∏ "–î—ñ–∞–Ω–∞"';
  };
})();
</script>

</body>
</html>
