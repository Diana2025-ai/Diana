<!DOCTYPE html>
<html lang="uk">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>–î—ñ–∞–Ω–∞ ‚Äî –≥–æ–ª–æ—Å–æ–≤–∏–π –ø–æ–º—ñ—á–Ω–∏–∫</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; }
    #log { white-space: pre-wrap; border: 1px solid #ccc; padding: 10px; height: 250px; overflow-y: auto; }
    button { margin-top: 10px; padding: 10px 15px; font-size: 16px; }
  </style>
</head>
<body>

<h2>–î—ñ–∞–Ω–∞ ‚Äî –≥–æ–ª–æ—Å–æ–≤–∏–π –ø–æ–º—ñ—á–Ω–∏–∫</h2>
<div id="log">–û—á—ñ–∫—É—é –∑–∞–ø—É—Å–∫...</div>
<button id="start-btn">–ó–∞–ø—É—Å—Ç–∏—Ç–∏ –î—ñ–∞–Ω—É</button>

<script>
(async () => {
  const logDiv = document.getElementById('log');
  const startBtn = document.getElementById('start-btn');

  const openWeatherKey = '9e41a977a87bb7f26c0afca1fba5b84f';
  const gptKey = 'sk-probny-gpt-key';
  const sanityProject = '50aa1yof';
  const sanityDataset = 'production';
  const sanityToken = 'sk6sza4rqhTXPAIeJsdcxqH6Mgr9Nut0Ia9qkLTdWs4RILSYOcFhYQDWTHJahTagTPTfLFyQPxleAMcCgzaZWlEGztOJjEoHnEQ1oQImjGINrisW311meoOjsl66AFRq91yxL2QUFDRhH77402CkMq3vRQpQvgwNDpLbRRykPU3CoSdZHDt4';

  function log(msg) {
    logDiv.textContent += '\n' + msg;
    logDiv.scrollTop = logDiv.scrollHeight;
  }

  let dianaVoice = null;
  function setVoice() {
    const voices = speechSynthesis.getVoices();
    dianaVoice = voices.find(v => v.lang.startsWith('uk')) || voices[0];
  }
  speechSynthesis.onvoiceschanged = setVoice;
  setVoice();

  function speak(text) {
    return new Promise(r => {
      if (speechSynthesis.speaking) speechSynthesis.cancel();
      const u = new SpeechSynthesisUtterance(text);
      u.voice = dianaVoice;
      u.lang = 'uk-UA';
      u.onend = r;
      speechSynthesis.speak(u);
      log('üó£ ' + text);
    });
  }

  async function getWeather(city) {
    const r = await fetch(`https://api.openweathermap.org/data/2.5/weather?q=${encodeURIComponent(city)}&appid=${openWeatherKey}&units=metric&lang=ua`);
    if (!r.ok) return null;
    return r.json();
  }

  async function askGPT(prompt) {
    try {
      const r = await fetch('https://api.openai.com/v1/chat/completions', {
        method: 'POST',
        headers: { 'Content-Type':'application/json', Authorization:`Bearer ${gptKey}` },
        body: JSON.stringify({
          model: 'gpt-3.5-turbo',
          messages: [{role:'system',content:'–¢–∏ ‚Äî –î—ñ–∞–Ω–∞, —É–∫—Ä–∞—ó–Ω—Å—å–∫–∏–π –≥–æ–ª–æ—Å–æ–≤–∏–π –ø–æ–º—ñ—á–Ω–∏–∫. –í—ñ–¥–ø–æ–≤—ñ–¥–∞–π –∫–æ—Ä–æ—Ç–∫–æ.'},{role:'user',content:prompt}],
          temperature:0.7
        })
      });
      const j = await r.json();
      return j.choices?.[0]?.message?.content?.trim();
    } catch {
      return null;
    }
  }

  async function sanityCreate(text) {
    await fetch(`https://${sanityProject}.api.sanity.io/v2021-10-21/data/mutate/${sanityDataset}`, {
      method:'POST',
      headers:{'Content-Type':'application/json',Authorization:`Bearer ${sanityToken}`},
      body: JSON.stringify({mutations:[{create:{_type:'memory',text}}]})
    });
  }

  async function sanityFetchAll() {
    const r = await fetch(`https://${sanityProject}.api.sanity.io/v2021-10-21/data/query/${sanityDataset}?query=*[_type=="memory"]{text}`);
    const j = await r.json();
    return j.result||[];
  }

  const rec = new (window.SpeechRecognition||window.webkitSpeechRecognition)();
  rec.lang = 'uk-UA';
  rec.continuous = true;
  rec.interimResults = false;

  let active = false;

  rec.onresult = async e => {
    const t = e.results[e.results.length-1][0].transcript.trim().toLowerCase();
    log('üëÇ ' + t);

    if (!active) {
      if (t.includes('–¥—ñ–∞–Ω–∞')) {
        active = true;
        await speak('–¢–∞–∫, —è —Å–ª—É—Ö–∞—é');
      }
      return;
    }

    if (t.startsWith('–∑–∞–ø–∞–º\'—è—Ç–∞–π ')) {
      const text = t.replace('–∑–∞–ø–∞–º\'—è—Ç–∞–π ','');
      await sanityCreate(text);
      await speak('–ó–∞–ø–∞–º‚Äô—è—Ç–∞–ª–∞.');
      return;
    }
    if (t.includes('—â–æ —Ç–∏ –ø–∞–º\'—è—Ç–∞—î—à')) {
      const arr = await sanityFetchAll();
      const txts = arr.slice(-5).map(a=>a.text).join('; ');
      await speak(txts?('–Ø –ø–∞–º‚Äô—è—Ç–∞—é: '+txts):'–ü–æ–∫–∏ –Ω—ñ—á–æ–≥–æ –Ω–µ –ø–∞–º‚Äô—è—Ç–∞—é.');
      return;
    }
    if (t.startsWith('–ø–æ–≥–æ–¥–∞ –≤ ')) {
      const city = t.replace('–ø–æ–≥–æ–¥–∞ –≤ ','').trim();
      const w = await getWeather(city);
      if (w) {
        await speak(`–£ ${city}: ${w.weather[0].description}, ${Math.round(w.main.temp)}¬∞C`);
      } else {
        await speak('–ù–µ –≤–¥–∞–ª–æ—Å—è –æ—Ç—Ä–∏–º–∞—Ç–∏ –ø–æ–≥–æ–¥—É.');
      }
      return;
    }
    const g = await askGPT(t);
    await speak(g || '–í–∏–±–∞—á, –Ω–µ –∑–Ω–∞—é —â–æ —Å–∫–∞–∑–∞—Ç–∏.');
  };

  rec.onerror = e => log('‚ùå ' + e.error);
  rec.onend = () => rec.start();

  startBtn.onclick = () => {
    rec.start();
    startBtn.disabled = true;
    log('‚úÖ –°–ª—É—Ö–∞—é, —Å–∫–∞–∂–∏ "–î—ñ–∞–Ω–∞"');
  };
})();
</script>

</body>
</html>
