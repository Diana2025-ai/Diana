package com.example.mistralchat

import android.os.Bundle
import android.speech.tts.TextToSpeech
import android.widget.Button
import android.widget.EditText
import android.widget.TextView
import androidx.appcompat.app.AppCompatActivity
import okhttp3.*
import org.json.JSONObject
import java.io.IOException
import java.util.*

class MainActivity : AppCompatActivity(), TextToSpeech.OnInitListener {
    private lateinit var tts: TextToSpeech
    private val client = OkHttpClient()
    private val mistralUrl = "http://192.168.1.10:11434/api/generate" // Замінити на IP ПК з Ollama

    override fun onCreate(savedInstanceState: Bundle?) {
        super.onCreate(savedInstanceState)
        setContentView(R.layout.activity_main)
        tts = TextToSpeech(this, this)

        val sendButton = findViewById<Button>(R.id.send_button)
        val userInput = findViewById<EditText>(R.id.user_input)
        val responseView = findViewById<TextView>(R.id.response_text)

        sendButton.setOnClickListener {
            val prompt = userInput.text.toString()
            sendPromptToMistral(prompt) { response ->
                runOnUiThread {
                    responseView.text = response
                    tts.speak(response, TextToSpeech.QUEUE_FLUSH, null, null)
                }
            }
        }
    }

    private fun sendPromptToMistral(prompt: String, callback: (String) -> Unit) {
        val json = JSONObject()
        json.put("model", "mistral")
        json.put("prompt", prompt)
        json.put("stream", false)

        val body = RequestBody.create(
            MediaType.parse("application/json"), json.toString()
        )
        val request = Request.Builder()
            .url(mistralUrl)
            .post(body)
            .build()

        client.newCall(request).enqueue(object : Callback {
            override fun onFailure(call: Call, e: IOException) {
                callback("Помилка: ${e.message}")
            }

            override fun onResponse(call: Call, response: Response) {
                val result = response.body()?.string()
                val reply = JSONObject(result).optString("response", "Нема відповіді")
                callback(reply)
            }
        })
    }

    override fun onInit(status: Int) {
        if (status == TextToSpeech.SUCCESS) {
            tts.language = Locale("uk", "UA")
            tts.setPitch(1.1f)
            tts.setSpeechRate(1.0f)
        }
    }

    override fun onDestroy() {
        tts.stop()
        tts.shutdown()
        super.onDestroy()
    }
}
