<script>
(async () => {
  const logDiv = document.getElementById('log');
  const startBtn = document.getElementById('start-btn');

  let dianaVoice = null;
  function selectDianaVoice() {
    const voices = speechSynthesis.getVoices();
    dianaVoice = voices.find(v => v.lang.startsWith('uk') && v.name.toLowerCase().includes('child')) 
               || voices.find(v => v.lang.startsWith('uk') && v.name.toLowerCase().includes('female'))
               || voices.find(v => v.lang.startsWith('uk')) 
               || voices[0];
  }

  speechSynthesis.onvoiceschanged = selectDianaVoice;
  selectDianaVoice();

  function speak(text) {
    return new Promise(resolve => {
      if (speechSynthesis.speaking) {
        speechSynthesis.cancel();
      }
      const utter = new SpeechSynthesisUtterance(text);
      utter.lang = 'uk-UA';
      utter.voice = dianaVoice;
      utter.onend = () => {
        recognition.start(); // üëà –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ –∑–∞–ø—É—Å–∫–∞—î —Ä–æ–∑–ø—ñ–∑–Ω–∞–≤–∞–Ω–Ω—è –ø—ñ—Å–ª—è –≤—ñ–¥–ø–æ–≤—ñ–¥—ñ
        resolve();
      };
      speechSynthesis.speak(utter);
    });
  }

  const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
  if (!SpeechRecognition) {
    logDiv.textContent = '–ü–æ–º–∏–ª–∫–∞: –≤–∞—à –±—Ä–∞—É–∑–µ—Ä –Ω–µ –ø—ñ–¥—Ç—Ä–∏–º—É—î SpeechRecognition.';
    return;
  }

  const recognition = new SpeechRecognition();
  recognition.lang = 'uk-UA';
  recognition.continuous = true;
  recognition.interimResults = false;

  let isActive = false;
  let isSpeaking = false;
  let lastResponse = '';

  const openWeatherApiKey = '9e41a977a87bb7f26c0afca1fba5b84f';

  async function getWeather(city) {
    try {
      const res = await fetch(`https://api.openweathermap.org/data/2.5/weather?q=${encodeURIComponent(city)}&appid=${openWeatherApiKey}&units=metric&lang=ua`);
      if (!res.ok) return null;
      const data = await res.json();
      return data;
    } catch {
      return null;
    }
  }

  recognition.onresult = async (event) => {
    if (isSpeaking) return;

    const transcript = event.results[event.results.length - 1][0].transcript.trim().toLowerCase();
    logDiv.textContent = `–ü–æ—á—É–≤: ${transcript}`;

    if (!isActive) {
      if (transcript.includes('–¥—ñ–∞–Ω–∞')) {
        isActive = true;
        lastResponse = '';
        await speak('–¢–∞–∫, —è —Ç—É—Ç');
        logDiv.textContent = '–ß–µ–∫–∞—é —Ç–≤—ñ–π –∑–∞–ø–∏—Ç...';
      }
      return;
    }

    isActive = false;
    isSpeaking = true;
    let answer = '';

    if (transcript.match(/–ø–æ–≥–æ–¥–∞ –≤ (.+)/)) {
      const city = transcript.match(/–ø–æ–≥–æ–¥–∞ –≤ (.+)/)[1].trim();
      const weatherData = await getWeather(city);
      if (weatherData) {
        answer = `–£ –º—ñ—Å—Ç—ñ ${city} –∑–∞—Ä–∞–∑ ${weatherData.weather[0].description}, —Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞ ${Math.round(weatherData.main.temp)} –≥—Ä–∞–¥—É—Å—ñ–≤.`;
      } else {
        answer = `–í–∏–±–∞—á, –Ω–µ –≤–¥–∞–ª–æ—Å—è –æ—Ç—Ä–∏–º–∞—Ç–∏ –ø–æ–≥–æ–¥—É –¥–ª—è ${city}.`;
      }
    }
    else if (transcript.includes('–ø—Ä–∏–≤—ñ—Ç')) {
      answer = '–ü—Ä–∏–≤—ñ—Ç! –Ø–∫ —Å–ø—Ä–∞–≤–∏?';
    }
    else if (transcript.includes('—è–∫ —Å–ø—Ä–∞–≤–∏')) {
      answer = '–£—Å–µ –¥–æ–±—Ä–µ, –¥—è–∫—É—é.';
    }
    else if (transcript.includes('–¥–æ–ø–æ–º–æ–∂–∏')) {
      answer = '–ß–∏–º –º–æ–∂—É –¥–æ–ø–æ–º–æ–≥—Ç–∏?';
    }
    else if (transcript.includes('–¥–æ –ø–æ–±–∞—á–µ–Ω–Ω—è') || transcript.includes('–ø–æ–∫–∞')) {
      answer = '–î–æ –∑—É—Å—Ç—Ä—ñ—á—ñ!';
    }
    else {
      answer = '–í–∏–±–∞—á, —è –Ω–µ –∑–Ω–∞—é, —â–æ –≤—ñ–¥–ø–æ–≤—ñ—Å—Ç–∏.';
    }

    if (answer === lastResponse) {
      isSpeaking = false;
      return;
    }
    lastResponse = answer;

    await speak(answer);
    isSpeaking = false;
  };

  recognition.onerror = (e) => {
    logDiv.textContent = `–ü–æ–º–∏–ª–∫–∞ —Ä–æ–∑–ø—ñ–∑–Ω–∞–≤–∞–Ω–Ω—è: ${e.error}`;
  };

  recognition.onend = () => {
    if (!isSpeaking) recognition.start();
  };

  startBtn.onclick = () => {
    recognition.start();
    startBtn.disabled = true;
    logDiv.textContent = '–î—ñ–∞–Ω–∞ –∑–∞–ø—É—â–µ–Ω–∞, —Å–ª—É—Ö–∞—é... –°–∫–∞–∂–∏ "–î—ñ–∞–Ω–∞" —â–æ–± –∞–∫—Ç–∏–≤—É–≤–∞—Ç–∏.';
  };
})();
</script>
