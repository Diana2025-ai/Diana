<!DOCTYPE html>
<html lang="uk">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Діана - голосовий помічник</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; }
    #log { white-space: pre-wrap; border: 1px solid #ccc; padding: 10px; height: 200px; overflow-y: scroll; }
    button { margin-top: 10px; padding: 10px 15px; font-size: 16px; }
  </style>
</head>
<body>

<h2>Діана - голосовий помічник</h2>
<div id="log">Статус: очікую команду...</div>
<button id="start-btn">Запустити Діану</button>

<script>
(async () => {
  const logDiv = document.getElementById('log');
  const startBtn = document.getElementById('start-btn');

  let dianaVoice = null;
  function selectDianaVoice() {
    const voices = speechSynthesis.getVoices();
    dianaVoice = voices.find(v => v.lang.startsWith('uk') && v.name.toLowerCase().includes('child')) 
               || voices.find(v => v.lang.startsWith('uk') && v.name.toLowerCase().includes('female'))
               || voices.find(v => v.lang.startsWith('uk')) 
               || voices[0];
  }

  speechSynthesis.onvoiceschanged = selectDianaVoice;
  selectDianaVoice();

  function speak(text) {
    if (speechSynthesis.speaking) {
      speechSynthesis.cancel();
    }
    return new Promise(resolve => {
      const utter = new SpeechSynthesisUtterance(text);
      utter.lang = 'uk-UA';
      utter.voice = dianaVoice;
      utter.onend = resolve;
      speechSynthesis.speak(utter);
    });
  }

  const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
  if (!SpeechRecognition) {
    logDiv.textContent = 'Помилка: ваш браузер не підтримує SpeechRecognition.';
    return;
  }

  const recognition = new SpeechRecognition();
  recognition.lang = 'uk-UA';
  recognition.continuous = true;
  recognition.interimResults = false;

  let isActive = false;
  let isSpeaking = false;
  let lastResponse = '';

  const openWeatherApiKey = '9e41a977a87bb7f26c0afca1fba5b84f';
  const openaiKey = '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';

  async function getWeather(city) {
    try {
      const res = await fetch(`https://api.openweathermap.org/data/2.5/weather?q=${encodeURIComponent(city)}&appid=${openWeatherApiKey}&units=metric&lang=ua`);
      if (!res.ok) return null;
      const data = await res.json();
      return data;
    } catch {
      return null;
    }
  }

  async function queryGPT(text) {
    try {
      const res = await fetch("https://api.openai.com/v1/chat/completions", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          Authorization: `Bearer ${openaiKey}`
        },
        body: JSON.stringify({
          model: "gpt-3.5-turbo",
          messages: [
            { role: "system", content: "Ти голосовий український помічник Діана. Відповідай коротко, ввічливо і зрозуміло." },
            { role: "user", content: text }
          ]
        })
      });
      const data = await res.json();
      return data.choices?.[0]?.message?.content?.trim();
    } catch (e) {
      console.error("GPT error:", e);
      return "Вибач, сталася помилка при зверненні до розуму.";
    }
  }

  recognition.onresult = async (event) => {
    if (isSpeaking) return;

    const transcript = event.results[event.results.length - 1][0].transcript.trim().toLowerCase();
    logDiv.textContent = `Почув: ${transcript}`;

    if (!isActive) {
      if (transcript.includes('діана')) {
        isActive = true;
        lastResponse = '';
        await speak('Так, я тут');
        logDiv.textContent = 'Чекаю твій запит...';
      }
      return;
    }

    isActive = false;
    isSpeaking = true;
    let answer = '';

    if (transcript.match(/погода в (.+)/)) {
      const city = transcript.match(/погода в (.+)/)[1].trim();
      const weatherData = await getWeather(city);
      if (weatherData) {
        answer = `У місті ${city} зараз ${weatherData.weather[0].description}, температура ${Math.round(weatherData.main.temp)} градусів.`;
      } else {
        answer = `Вибач, не вдалося отримати погоду для ${city}.`;
      }
    }
    else if (transcript.includes('привіт')) {
      answer = 'Привіт, Вадіме! Як справи?';
    }
    else if (transcript.includes('як справи')) {
      answer = 'Усе добре, дякую!';
    }
    else if (transcript.includes('допоможи')) {
      answer = 'Чим можу допомогти?';
    }
    else if (transcript.includes('до побачення') || transcript.includes('пока')) {
      answer = 'До зустрічі!';
    }
    else {
      answer = await queryGPT(transcript) || 'Вибач, я не знаю, що сказати.';
    }

    if (answer === lastResponse) {
      isSpeaking = false;
      logDiv.textContent = 'Вже відповідала цим.';
      return;
    }
    lastResponse = answer;

    await speak(answer);
    isSpeaking = false;
    logDiv.textContent = `Відповідь: ${answer}`;
  };

  recognition.onerror = (e) => {
    logDiv.textContent = `Помилка розпізнавання: ${e.error}`;
  };

  recognition.onend = () => {
    if (!isSpeaking) recognition.start();
  };

  startBtn.onclick = () => {
    recognition.start();
    startBtn.disabled = true;
    logDiv.textContent = 'Діана запущена, скажи "Діана", щоб активувати.';
  };

})();
</script>

</body>
</html>
